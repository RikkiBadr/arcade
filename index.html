<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Crypto Arcade ‚Ä¢ Play ‚Ä¢ Compete ‚Ä¢ Earn</title>
<meta name="description" content="Neon arcade with sign-in, 4 canvas games (Flappy, Snake, 2048, Tetris), local leaderboard, Treasury (coming soon), and Phantom pay button."/>
<style>
  :root{
    --bg:#0b0f14; --panel:#0f1421; --panel-2:#11182a;
    --text:#eef5ff; --muted:#9aa8bc;
    --accent:#ff57de; --accent2:#57ffd3; --accent3:#ffd45a;
    --line:rgba(255,255,255,.10); --glow:0 0 28px rgba(255,87,222,.35);
    --card-glow:0 24px 60px rgba(0,0,0,.45), 0 0 40px rgba(255,87,222,.08);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--text);
    background:
      radial-gradient(1200px 800px at -10% -20%, rgba(255,87,222,.10), transparent 60%),
      radial-gradient(1200px 800px at 120% -30%, rgba(87,255,211,.08), transparent 60%),
      #0b0f14;
  }
  a{color:inherit}
  header{position:sticky; top:0; z-index:20; backdrop-filter:saturate(120%) blur(8px);
    background:linear-gradient(180deg, rgba(11,15,20,.92), rgba(11,15,20,.55) 60%, rgba(11,15,20,0)); border-bottom:1px solid var(--line)}
  .top{max-width:1200px; margin:auto; padding:12px 16px; display:flex; align-items:center; justify-content:space-between; gap:16px}
  .brand{display:flex; align-items:center; gap:12px}
  .logo{width:34px; aspect-ratio:1; border-radius:10px; background:conic-gradient(from 180deg, var(--accent), var(--accent2), var(--accent3), var(--accent)); box-shadow:var(--glow)}
  .brand h1{font-size:18px; letter-spacing:.04em; margin:0}
  .nav{display:flex; align-items:center; gap:12px}
  .chip{font-size:12px; color:var(--muted); padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:#0f1628}
  .btn{padding:10px 14px; border-radius:12px; border:1px solid var(--line); background:#121a31; color:#fff; cursor:pointer; transition:transform .06s ease}
  .btn-primary{background:linear-gradient(180deg, #232a5a, #121a31); border-color:rgba(255,255,255,.18)}
  .btn:hover{transform:translateY(-1px)}
  .hero{max-width:1200px; margin:18px auto 8px; padding:0 16px; text-align:center}
  .bar{height:54px; border-radius:14px; border:1px solid rgba(255,87,222,.35); background:linear-gradient(90deg, #ff57de, #7c67ff, #57ffd3);
        box-shadow:0 0 30px rgba(255,87,222,.25); margin:10px auto 6px; max-width:740px}
  .hero h2{margin:6px 0 0; font-weight:600} .hero p{max-width:880px; margin:10px auto; color:var(--muted); line-height:1.6}
  .notice{max-width:1200px; margin:18px auto 0; padding:12px 16px; border:1px solid var(--line); border-radius:12px; background:#121a31; color:#cfe3ff; text-align:center}

  .wrap{max-width:1200px; margin:18px auto 40px; padding:0 16px}
  .section-title{font-size:22px; margin:14px 0}

  .games-grid{display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:18px}
  @media (max-width:1200px){ .games-grid{grid-template-columns:repeat(2,minmax(0,1fr))} }
  @media (max-width:680px){ .games-grid{grid-template-columns:1fr} }

  .card{background:linear-gradient(180deg, var(--panel-2), #0f1421); border:1px solid var(--line); border-radius:18px; overflow:hidden; box-shadow:var(--card-glow); display:flex; flex-direction:column}
  .thumb{position:relative; aspect-ratio:16/9; overflow:hidden; border-bottom:1px solid var(--line)}
  .thumb svg{width:100%; height:100%; display:block}
  .title-overlay{position:absolute; left:14px; bottom:12px; padding:6px 10px 7px; border-radius:10px; font-weight:700; background:rgba(11,15,20,.55); border:1px solid rgba(255,255,255,.2); text-shadow:0 0 14px rgba(255,87,222,.6)}
  .body{padding:12px 14px; color:var(--muted)}
  .stats{display:grid; grid-template-columns:1fr 1fr; gap:10px; padding:12px 14px; border-top:1px solid var(--line); background:#0f1628}
  .stat{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 10px; border:1px solid var(--line); border-radius:10px; color:#cfe3ff; background:linear-gradient(180deg,#0f1628,#0b1222)}
  .actions{display:flex; padding:12px 14px; gap:10px; border-top:1px solid var(--line)} .actions .btn{flex:1}

  .panel{background:#0f1421; border:1px solid var(--line); border-radius:18px; padding:14px; margin-top:26px}
  .controls{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  label{font-size:13px; color:var(--muted)}
  select,input[type="text"],input[type="number"]{appearance:none; border:none; outline:none; background:#0f1628; color:#fff; border:1px solid var(--line); border-radius:10px; padding:10px 12px}
  .stage{margin-top:12px; border:1px solid var(--line); border-radius:14px; overflow:hidden; background:#060a13; aspect-ratio:16/9; display:grid; place-items:center}
  canvas{width:100%; height:100%}
  .two-col{display:grid; grid-template-columns:1fr 320px; gap:16px}
  @media (max-width:1020px){ .two-col{grid-template-columns:1fr} }
  .kpi{display:flex; align-items:center; justify-content:space-between; background:#0f1628; border:1px solid var(--line); border-radius:10px; padding:10px 12px; margin:8px 0}
  .kbd{font-family:ui-monospace,Menlo,monospace; font-size:12px; padding:2px 6px; border:1px solid rgba(255,255,255,.22); border-radius:6px; color:#bed8ff}
  .leader-list{display:grid; gap:8px} .leader-item{display:flex; justify-content:space-between; padding:8px 10px; background:#0f1628; border:1px solid var(--line); border-radius:10px}

  /* Treasury (Coming Soon) */
  .treasury-card{display:flex; gap:16px; align-items:center; padding:8px 2px}
  .treasury-icon{display:grid; place-items:center; width:96px; height:96px; border-radius:16px; background:#121a31; border:1px solid var(--line);
                 box-shadow:0 0 26px rgba(255,87,222,.12), inset 0 0 20px rgba(255,255,255,.05)}
  .soon-pill{display:inline-block; padding:8px 12px; border-radius:999px; border:1px dashed rgba(255,255,255,.25); background:#0f1628; color:#cfe3ff; font-weight:600; letter-spacing:.02em}

  footer{margin:40px 0 30px; text-align:center; color:var(--muted); font-size:13px}
  footer a.btn-telegram{display:inline-flex; align-items:center; gap:8px; margin-top:8px; padding:8px 14px; border-radius:10px; background:#0f1628; border:1px solid rgba(255,255,255,.15); text-decoration:none; color:#cfe3ff; font-weight:500}
</style>
</head>
<body>

<header>
  <div class="top">
    <div class="brand"><div class="logo"></div><h1>CREATOR ARCADE</h1></div>
    <div class="nav">
      <a class="chip" id="hello">Guest</a>
      <a class="chip" id="toLeaderboardsBtn" href="#lbArea">Leaderboards</a>
      <a class="chip" id="toTreasuryBtn" href="#treasury">Treasury</a>
      <button class="btn" id="signinBtn">Sign in</button>
      <button class="btn btn-primary" id="signupBtn">Sign up</button>
    </div>
  </div>
</header>

<section class="hero">
  <div class="bar" aria-hidden="true"></div>
  <h2>Play ‚Ä¢ Compete ‚Ä¢ Earn</h2>
  <p>Play classic games, climb the <strong>leaderboards</strong>, and win creator rewards. Compete now and earn while you play!</p>
</section>
<div class="notice">üéÆ <strong>Sign in</strong> to save your scores and compete on leaderboards!</div>

<div class="wrap">
  <h3 class="section-title">Games</h3>

  <!-- GAME CARDS with inline SVG thumbs -->
  <div class="games-grid">
    <!-- Flappy -->
    <article class="card">
      <div class="thumb">
        <svg viewBox="0 0 160 90" preserveAspectRatio="xMidYMid slice">
          <defs>
            <linearGradient id="flbg" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stop-color="#152241"/>
              <stop offset="100%" stop-color="#0a111f"/>
            </linearGradient>
          </defs>
          <rect width="160" height="90" fill="url(#flbg)"/>
          <rect x="60" y="0"   width="14" height="36" fill="#ff57de"/>
          <rect x="60" y="56"  width="14" height="34" fill="#ff57de"/>
          <rect x="110" y="0"  width="14" height="26" fill="#ff57de"/>
          <rect x="110" y="46" width="14" height="44" fill="#ff57de"/>
          <circle cx="34" cy="45" r="7" fill="#57ffd3"/>
        </svg>
        <div class="title-overlay">Flappy Bird</div>
      </div>
      <div class="body">Navigate through pipes in this endless flying game.</div>
      <div class="stats">
        <div class="stat"><span>High Score</span><strong id="sflappy">‚Äî</strong></div>
        <div class="stat"><span>Times Played</span><strong id="pflappy">‚Äî</strong></div>
      </div>
      <div class="actions">
        <button class="btn btn-primary" data-play="flappy">Play</button>
        <button class="btn" data-leader="flappy">Leaderboard</button>
      </div>
    </article>

    <!-- Snake -->
    <article class="card">
      <div class="thumb">
        <svg viewBox="0 0 160 90" preserveAspectRatio="xMidYMid slice">
          <rect width="160" height="90" fill="#0d1326"/>
          <rect x="40" y="44" width="8" height="8" fill="#ff57de"/>
          <rect x="48" y="44" width="8" height="8" fill="#ff57de"/>
          <rect x="56" y="44" width="8" height="8" fill="#ff57de"/>
          <rect x="64" y="44" width="8" height="8" fill="#ff57de"/>
          <rect x="72" y="44" width="8" height="8" fill="#ff57de"/>
          <rect x="110" y="28" width="8" height="8" fill="#57ffd3"/>
        </svg>
        <div class="title-overlay">Snake</div>
      </div>
      <div class="body">Guide the snake, eat food, grow longer. Don‚Äôt bite yourself!</div>
      <div class="stats">
        <div class="stat"><span>High Score</span><strong id="ssnake">‚Äî</strong></div>
        <div class="stat"><span>Times Played</span><strong id="psnake">‚Äî</strong></div>
      </div>
      <div class="actions">
        <button class="btn btn-primary" data-play="snake">Play</button>
        <button class="btn" data-leader="snake">Leaderboard</button>
      </div>
    </article>

    <!-- 2048 -->
    <article class="card">
      <div class="thumb">
        <svg viewBox="0 0 160 90" preserveAspectRatio="xMidYMid slice">
          <rect width="160" height="90" fill="#0e1631"/>
          <rect x="34" y="20" width="24" height="24" rx="4" fill="#57ffd3"/>
          <rect x="62" y="20" width="24" height="24" rx="4" fill="#ff57de"/>
          <rect x="90" y="20" width="24" height="24" rx="4" fill="#ffd45a"/>
          <rect x="62" y="48" width="24" height="24" rx="4" fill="#57ffd3"/>
          <text x="46" y="36" font-family="ui-monospace,Menlo,monospace" font-size="12" text-anchor="middle" fill="#061018">2</text>
          <text x="74" y="36" font-size="12" text-anchor="middle" fill="#061018">4</text>
          <text x="102" y="36" font-size="12" text-anchor="middle" fill="#061018">8</text>
          <text x="74" y="64" font-size="12" text-anchor="middle" fill="#061018">2</text>
        </svg>
        <div class="title-overlay">2048</div>
      </div>
      <div class="body">Slide tiles to combine numbers and reach 2048.</div>
      <div class="stats">
        <div class="stat"><span>High Score</span><strong id="s2048">‚Äî</strong></div>
        <div class="stat"><span>Times Played</span><strong id="p2048">‚Äî</strong></div>
      </div>
      <div class="actions">
        <button class="btn btn-primary" data-play="2048">Play</button>
        <button class="btn" data-leader="2048">Leaderboard</button>
      </div>
    </article>

    <!-- Tetris -->
    <article class="card">
      <div class="thumb">
        <svg viewBox="0 0 160 90" preserveAspectRatio="xMidYMid slice">
          <rect width="160" height="90" fill="#0c1328"/>
          <rect x="24" y="66" width="16" height="16" fill="#57ffd3"/>
          <rect x="40" y="66" width="16" height="16" fill="#57ffd3"/>
          <rect x="56" y="66" width="16" height="16" fill="#57ffd3"/>
          <rect x="72" y="66" width="16" height="16" fill="#57ffd3"/>
          <rect x="40" y="50" width="16" height="16" fill="#ffd45a"/>
          <rect x="56" y="50" width="16" height="16" fill="#ffd45a"/>
          <rect x="56" y="34" width="16" height="16" fill="#ff57de"/>
          <rect x="72" y="50" width="16" height="16" fill="#ffd45a"/>
          <rect x="104" y="18" width="16" height="16" fill="#a857ff"/>
          <rect x="104" y="34" width="16" height="16" fill="#a857ff"/>
          <rect x="120" y="34" width="16" height="16" fill="#a857ff"/>
        </svg>
        <div class="title-overlay">Tetris</div>
      </div>
      <div class="body">Stack falling tetrominoes. Clear lines for points.</div>
      <div class="stats">
        <div class="stat"><span>High Score</span><strong id="stetris">‚Äî</strong></div>
        <div class="stat"><span>Times Played</span><strong id="ptetris">‚Äî</strong></div>
      </div>
      <div class="actions">
        <button class="btn btn-primary" data-play="tetris">Play</button>
        <button class="btn" data-leader="tetris">Leaderboard</button>
      </div>
    </article>
  </div>

  <!-- GAME + SIDEBAR -->
  <section class="panel two-col" id="gameArea" style="display:none">
    <div>
      <div class="controls">
        <label for="game">Game</label>
        <select id="game">
          <option value="flappy">Flappy</option>
          <option value="snake">Snake</option>
          <option value="2048">2048</option>
          <option value="tetris">Tetris</option>
        </select>
        <button class="btn btn-primary" id="playBtn">‚ñ∂ Play / Restart</button>
        <span class="chip">FPS <span id="fps">‚Äî</span></span>
        <span class="chip">Screen <span id="screen">‚Äî</span></span>
      </div>
      <div class="stage"><canvas id="canvas" width="960" height="540"></canvas></div>
    </div>

    <aside>
      <div class="kpi"><span>Score</span><strong id="score">0</strong></div>
      <div class="kpi"><span>Best (local)</span><strong id="best">0</strong></div>
      <div class="kpi"><span>State</span><strong id="state">idle</strong></div>
      <div class="panel">
        Controls:
        <span class="kbd">Arrows</span> / <span class="kbd">WASD</span> ‚Äî
        <span class="kbd">Space</span> (Flappy jump) ‚Äî
        <span class="kbd">‚Üë</span> rotate (Tetris) ‚Äî
        <span class="kbd">P</span> pause
      </div>
    </aside>
  </section>

  <!-- LEADERBOARD -->
  <section class="panel" id="lbArea" style="display:none">
    <div class="controls" style="margin-bottom:10px">
      <label>Game</label>
      <select id="lbGame">
        <option value="flappy">Flappy</option>
        <option value="snake">Snake</option>
        <option value="2048">2048</option>
        <option value="tetris">Tetris</option>
      </select>
      <button class="btn" id="clearLB">Clear Game Leaderboard</button>
    </div>
    <div class="leader-list" id="leaderList"></div>
  </section>

  <!-- TREASURY (Coming Soon) -->
  <section class="panel" id="treasury">
    <div class="treasury-card">
      <div class="treasury-icon" aria-hidden="true">
        <svg viewBox="0 0 128 128" width="84" height="84">
          <defs>
            <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%"  stop-color="#ffd45a"/>
              <stop offset="100%" stop-color="#ff8a57"/>
            </linearGradient>
            <linearGradient id="g2" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%"  stop-color="#ff57de"/>
              <stop offset="100%" stop-color="#7c67ff"/>
            </linearGradient>
          </defs>
          <rect x="12" y="28" width="104" height="26" rx="6" fill="url(#g2)" opacity="0.95"/>
          <rect x="16" y="48" width="96" height="62" rx="10" fill="url(#g1)" />
          <rect x="58" y="60" width="12" height="18" rx="3" fill="#0b0f14" opacity="0.9"/>
          <circle cx="64" cy="76" r="5" fill="#0b0f14"/>
        </svg>
      </div>
      <div>
        <h3 style="margin:0 0 6px">Treasury ‚Äî Lock & Earn</h3>
        <p class="muted" style="margin:6px 0 10px">
          Soon you‚Äôll be able to <strong>lock your winnings for 7 days</strong> to earn a bonus.
          The longer you play and lock, the bigger your boost. Early-unlock fees help fund rewards.
        </p>
        <div class="soon-pill">Coming soon</div>
      </div>
    </div>
  </section>

  <!-- PAY WITH PHANTOM -->
  <section class="panel" id="pay">
    <h3 style="margin:0 0 10px">Send SOL to Play / Support</h3>
    <div class="controls" style="gap:12px">
      <label>Your Phantom address (treasury)</label>
      <input id="treasuryAddress" value="BYThp41FMgJRdQkWZk3iqU54LCm4azTVxfR91gzMMArt" style="min-width:340px"/>
      <label>Amount (SOL)</label>
      <input id="amountSol" type="number" step="0.000000001" placeholder="0.05" style="max-width:160px"/>
      <button id="phantomPayBtn" class="btn btn-primary">Pay with Phantom</button>
    </div>
    <p class="muted" style="margin-top:10px">
      You‚Äôll be asked to approve the transaction in Phantom. Funds go straight to the treasury address.
    </p>
  </section>
</div>

<footer>
  <p>Built with ‚ù§Ô∏è for the Solana community ‚Ä¢ <strong>Compete, Earn, Repeat</strong></p>
  <a class="btn-telegram" href="https://t.me/CryptoArcade2025" target="_blank" rel="noopener noreferrer">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240" width="18" height="18" fill="#29a9eb" aria-hidden="true">
      <circle cx="120" cy="120" r="120" fill="#29a9eb"/>
      <path fill="#fff" d="M174 66L48 116c-9 3-9 9-2 12l30 9 12 37c1 4 2 5 6 3l17-14 34 25c6 3 10 1 11-5l20-97c2-8-3-12-9-9z"/>
    </svg>
    Join us on Telegram
  </a>
</footer>

<!-- Solana web3.js (pinned) -->
<script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>

<script>
(() => {
  const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
  const looksLikeSol = s => /^[1-9A-HJ-NP-Za-km-z]{32,44}$/.test(s);
  const short = a => a ? a.slice(0,4)+'‚Ä¶'+a.slice(-4) : '‚Äî';

  // storage keys
  const BEST_KEY='arcade_best_v6', LB_KEY='arcade_lb_v6', PROFILE_KEY='arcade_profile_v3';

  let best=Number(localStorage.getItem(BEST_KEY)||0);
  const getLB=()=>{try{return JSON.parse(localStorage.getItem(LB_KEY)||'{}')}catch{return{}}}
  const setLB=o=>localStorage.setItem(LB_KEY,JSON.stringify(o));
  const getProfile=()=>{try{return JSON.parse(localStorage.getItem(PROFILE_KEY)||'{}')}catch{return{}}}
  const setProfile=p=>{localStorage.setItem(PROFILE_KEY,JSON.stringify(p)); renderHello();}

  // sanitize helper
  function cleanText(s, max=32){ s=String(s||'').replace(/<[^>]*>/g,''); return s.slice(0,max); }

  const renderHello=()=>{
    const p=getProfile();
    $('#hello').textContent=(p.nickname||'Guest')+(p.payout?(' ‚Ä¢ '+short(p.payout)):'')
  }
  renderHello();

  // header links smooth scroll
  $('#toLeaderboardsBtn').onclick = (e)=>{ e.preventDefault(); $('#lbArea').style.display='block'; window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'}); };
  $('#toTreasuryBtn').onclick = (e)=>{ e.preventDefault(); document.getElementById('treasury').scrollIntoView({ behavior:'smooth', block:'start' }); };

  // auth modal
  const modal = (()=>{
    const backdrop = document.createElement('div');
    backdrop.className='modal-backdrop'; backdrop.id='authModal';
    backdrop.innerHTML = `<style>
      .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; place-items:center; z-index:50}
      .modal{width:min(560px,92vw); background:#0f1421; border:1px solid var(--line); border-radius:16px; padding:16px}
      .modal h3{margin:6px 0 10px} .row{display:flex; gap:10px; flex-wrap:wrap} .row>div{flex:1}
      .modal input{width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#0f1628; color:#fff}
      .seg{display:flex; gap:8px; margin-bottom:10px} .seg .btn{flex:1; text-align:center}
    </style>
    <div class="modal">
      <div class="seg">
        <button class="btn" id="segSignin">Sign in</button>
        <button class="btn btn-primary" id="segSignup">Sign up</button>
      </div>
      <div id="signinForm">
        <h3>Sign in</h3>
        <div class="row">
          <div><label>Nickname</label><input id="nickIn" placeholder="Your nickname"/></div>
          <div><label>Payout Solana address</label><input id="payoutIn" placeholder="Your SOL address"/></div>
        </div>
        <div style="margin-top:10px"><button class="btn btn-primary" id="saveSignin">Sign in</button></div>
      </div>
      <div id="signupForm" style="display:none">
        <h3>Create account</h3>
        <div class="row">
          <div><label>Nickname</label><input id="nick" placeholder="e.g. MoonBoy"/></div>
          <div><label>Payout (deposit) Solana address</label><input id="payout" placeholder="SOL address for rewards"/></div>
        </div>
        <div style="margin-top:10px"><button class="btn btn-primary" id="saveSignup">Save</button></div>
      </div>
    </div>`;
    document.body.appendChild(backdrop);
    return backdrop;
  })();

  function showModal(mode){
    modal.style.display='grid';
    $('#signinForm').style.display = mode==='signin'?'block':'none';
    $('#signupForm').style.display = mode==='signup'?'block':'none';
  }
  function hideModal(){ modal.style.display='none'; }
  $('#signinBtn').onclick=()=>showModal('signin');
  $('#signupBtn').onclick=()=>showModal('signup');
  modal.addEventListener('click', e=>{ if(e.target.id==='authModal') hideModal(); });
  document.addEventListener('click', e=>{
    if(e.target.id==='segSignin') showModal('signin');
    if(e.target.id==='segSignup') showModal('signup');
    if(e.target.id==='saveSignup'){
      const p={ nickname: cleanText($('#nick').value||'Player',20), payout: cleanText($('#payout').value||'',60) };
      if(p.payout && !looksLikeSol(p.payout)) return alert('Invalid Solana address.');
      setProfile(p); hideModal();
    }
    if(e.target.id==='saveSignin'){
      const p={ nickname: cleanText($('#nickIn').value||'Player',20), payout: cleanText($('#payoutIn').value||'',60) };
      if(p.payout && !looksLikeSol(p.payout)) return alert('Invalid Solana address.');
      setProfile(p); hideModal();
    }
  });

  // navigate from cards
  $$('.actions [data-play]').forEach(b=>b.onclick=()=>{ $('#game').value=b.dataset.play; startSection('game'); startGame(); incPlays(b.dataset.play); });
  $$('.actions [data-leader]').forEach(b=>b.onclick=()=>{ $('#lbGame').value=b.dataset.leader; startSection('leader'); renderLB(); });

  function startSection(w){
    if(w==='game'){
      $('#gameArea').style.display='grid';
      $('#lbArea').style.display='none';
    }else{
      $('#gameArea').style.display='none';
      $('#lbArea').style.display='block';
    }
    window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'});
  }

  // canvas / game loop
  const canvas=$('#canvas'), ctx=canvas.getContext('2d');
  const scoreEl=$('#score'), bestEl=$('#best'), stateEl=$('#state'), fpsEl=$('#fps'), screenEl=$('#screen');
  bestEl.textContent=best;
  function resize(){const r=canvas.getBoundingClientRect(); screenEl.textContent=Math.round(r.width)+'√ó'+Math.round(r.height)}
  window.addEventListener('resize',resize); resize();

  let game,running=false,last=0,frames=0,fps=0,paused=false;
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v)), rand=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;

  class Base{constructor(){this.score=0} start(){} update(){} draw(){} key(){}}

  // Flappy
  class Flappy extends Base{
    constructor(){super(); this.reset()}
    reset(){ this.bird={x:160,y:canvas.height/2,vy:0}; this.g=900; this.impulse=-320; this.pipes=[]; this.t=0; this.every=1500; this.speed=150; this.gap=170; this.alive=true; this.score=0; }
    start(){this.reset()}
    update(dt){ if(!this.alive)return; this.bird.vy+=this.g*(dt/1000); this.bird.y+=this.bird.vy*(dt/1000);
      this.t+=dt; while(this.t>this.every){ this.t-=this.every; const h=rand(80,canvas.height-80-this.gap); this.pipes.push({x:canvas.width+40,top:h,bottom:h+this.gap,w:70,scored:false}); }
      this.pipes.forEach(p=>p.x-=this.speed*(dt/1000)); this.pipes=this.pipes.filter(p=>p.x+p.w>-10);
      if(this.bird.y<0||this.bird.y>canvas.height){ this.alive=false; gameOver(); }
      for(const p of this.pipes){ if(this.bird.x>p.x+p.w&&!p.scored){p.scored=true; this.score++}
        if(this.bird.x>p.x-12&&this.bird.x<p.x+p.w+12){ if(this.bird.y<p.top||this.bird.y>p.bottom){ this.alive=false; gameOver(); } } }
    }
    draw(){ const g=ctx.createLinearGradient(0,0,0,canvas.height); g.addColorStop(0,'#152241'); g.addColorStop(1,'#0a111f'); ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width,canvas.height);
      this.pipes.forEach(p=>{ ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--accent'); ctx.fillRect(p.x,0,p.w,p.top); ctx.fillRect(p.x,p.bottom,p.w,canvas.height-p.bottom); });
      ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--accent2'); ctx.beginPath(); ctx.arc(this.bird.x,this.bird.y,12,0,Math.PI*2); ctx.fill();
      drawHUD(this.score);
    }
    key(k,d){ if(!d)return; if(k==='Space'||k==='ArrowUp'||k==='KeyW') this.bird.vy=this.impulse; }
  }

  // Snake
  class Snake extends Base{
    constructor(){super(); this.gs=24; this.cols=Math.floor(canvas.width/this.gs); this.rows=Math.floor(canvas.height/this.gs); this.reset()}
    reset(){ this.dir={x:1,y:0}; this.snake=[{x:5,y:5}]; this.food=this.spawn(); this.t=0; this.step=110; this.score=0; }
    spawn(){ let p; do{ p={x:rand(0,this.cols-1),y:rand(0,this.rows-1)} }while(this.snake.some(s=>s.x===p.x&&s.y===p.y)); return p; }
    start(){this.reset()}
    update(dt){ this.t+=dt; while(this.t>this.step){ this.t-=this.step; const h={x:this.snake[0].x+this.dir.x,y:this.snake[0].y+this.dir.y}; h.x+=(this.cols); h.y+=(this.rows); h.x%=this.cols; h.y%=this.rows;
      if(this.snake.some((s,i)=>i&&s.x===h.x&&s.y===h.y)){ gameOver(); return; } this.snake.unshift(h); if(h.x===this.food.x&&h.y===this.food.y){ this.score+=10; this.food=this.spawn(); this.step=Math.max(50,this.step-3);} else this.snake.pop(); } }
    draw(){ ctx.fillStyle='#0d1326'; ctx.fillRect(0,0,canvas.width,canvas.height);
      for(let x=0;x<canvas.width;x+=this.gs){ ctx.fillStyle='rgba(255,255,255,.05)'; ctx.fillRect(x,0,1,canvas.height)}
      for(let y=0;y<canvas.height;y+=this.gs){ ctx.fillStyle='rgba(255,255,255,.05)'; ctx.fillRect(0,y,canvas.width,1)}
      ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--accent2'); ctx.fillRect(this.food.x*this.gs,this.food.y*this.gs,this.gs,this.gs);
      ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--accent'); this.snake.forEach((s,i)=>{ const a=Math.max(.3,1-i/this.snake.length); ctx.globalAlpha=a; ctx.fillRect(s.x*this.gs+1,s.y*this.gs+1,this.gs-2,this.gs-2); ctx.globalAlpha=1; });
      drawHUD(this.score);
    }
    key(k,d){ if(!d)return; const t=this.dir; if(k==='ArrowUp'||k==='KeyW'){ if(t.y!==1) this.dir={x:0,y:-1} } if(k==='ArrowDown'||k==='KeyS'){ if(t.y!==-1) this.dir={x:0,y:1} } if(k==='ArrowLeft'||k==='KeyA'){ if(t.x!==1) this.dir={x:-1,y:0} } if(k==='ArrowRight'||k==='KeyD'){ if(t.x!==-1) this.dir={x:1,y:0} } }
  }

  // 2048
  class G2048 extends Base{
    constructor(){super(); this.grid=[...Array(4)].map(()=>Array(4).fill(0)); this.reset()}
    reset(){ this.grid.forEach(r=>r.fill(0)); this.add(); this.add(); this.score=0; }
    start(){this.reset()}
    add(){ const e=[]; for(let y=0;y<4;y++)for(let x=0;x<4;x++) if(!this.grid[y][x]) e.push({x,y}); if(!e.length) return; const p=e[Math.floor(Math.random()*e.length)]; this.grid[p.y][p.x]=Math.random()<0.9?2:4; }
    slide(r){ const a=r.filter(v=>v); for(let i=0;i<a.length-1;i++){ if(a[i]===a[i+1]){ a[i]*=2; this.score+=a[i]; a.splice(i+1,1);} } while(a.length<4) a.push(0); return a; }
    move(d){ let m=false;
      if(d===0){ for(let y=0;y<4;y++){ const n=this.slide(this.grid[y]); if(n.some((v,i)=>v!==this.grid[y][i])) m=true; this.grid[y]=n; } }
      if(d===1){ for(let y=0;y<4;y++){ let r=[...this.grid[y]].reverse(); r=this.slide(r).reverse(); if(r.some((v,i)=>v!==this.grid[y][i])) m=true; this.grid[y]=r; } }
      if(d===2){ for(let x=0;x<4;x++){ let c=[0,1,2,3].map(y=>this.grid[y][x]); c=this.slide(c); if(c.some((v,i)=>v!==this.grid[i][x])) m=true; for(let y=0;y<4;y++) this.grid[y][x]=c[y]; } }
      if(d===3){ for(let x=0;x<4;x++){ let c=[0,1,2,3].map(y=>this.grid[y][x]).reverse(); c=this.slide(c).reverse(); if(c.some((v,i)=>v!==this.grid[i][x])) m=true; for(let y=0;y<4;y++) this.grid[y][x]=c[y]; } }
      if(m) this.add(); if(this.over()) gameOver();
    }
    over(){ for(let y=0;y<4;y++)for(let x=0;x<4;x++){ if(!this.grid[y][x]) return false; if(x<3&&this.grid[y][x]===this.grid[y][x+1]) return false; if(y<3&&this.grid[y][x]===this.grid[y+1][x]) return false; } return true; }
    update(){} draw(){ ctx.fillStyle='#0e1631'; ctx.fillRect(0,0,canvas.width,canvas.height);
      const s=100, offX=(canvas.width-4*s)/2, offY=(canvas.height-4*s)/2;
      for(let y=0;y<4;y++)for(let x=0;x<4;x++){ const v=this.grid[y][x];
        ctx.fillStyle='rgba(255,255,255,.08)'; ctx.fillRect(offX+x*s+6,offY+y*s+6,s-12,s-12);
        if(v){ ctx.fillStyle= v<8? '#57ffd3' : v<32? '#ff57de' : v<128? '#ffd45a' : '#f7fbff';
          ctx.fillRect(offX+x*s+6,offY+y*s+6,s-12,s-12);
          ctx.fillStyle='#061018'; ctx.font='24px ui-monospace, Menlo, monospace'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(String(v), offX+x*s+s/2, offY+y*s+s/2);
        }
      }
      drawHUD(this.score);
    }
    key(k,d){ if(!d)return; if(k==='ArrowLeft') this.move(0); if(k==='ArrowRight') this.move(1); if(k==='ArrowUp') this.move(2); if(k==='ArrowDown') this.move(3); }
  }

  // Tetris
  class Tetris extends Base{
    constructor(){super(); this.w=10; this.h=20; this.reset()}
    reset(){ this.board=[...Array(this.h)].map(()=>Array(this.w).fill(0)); this.bag=[]; this.next=this.pick(); this.spawn(); this.t=0; this.step=550; this.score=0; }
    start(){this.reset()}
    pick(){ const P=['I','O','T','S','Z','J','L']; if(this.bag.length===0) this.bag=P.sort(()=>Math.random()-0.5); return this.bag.pop(); }
    shapes(c){ const M={I:[[1,1,1,1]], O:[[1,1],[1,1]], T:[[1,1,1],[0,1,0]], S:[[0,1,1],[1,1,0]], Z:[[1,1,0],[0,1,1]], J:[[1,0,0],[1,1,1]], L:[[0,0,1],[1,1,1]]}; return M[c]; }
    colors={I:'#57ffd3',O:'#ffd45a',T:'#ff57de',S:'#57ff8a',Z:'#ff8a57',J:'#57a2ff',L:'#a857ff'}
    spawn(){ this.cur={m:this.shapes(this.next), x:3, y:0, c:this.next}; this.next=this.pick(); if(this.collide(this.cur.m,this.cur.x,this.cur.y)) gameOver(); }
    rot(m){ const r=[...Array(m[0].length)].map(()=>Array(m.length).fill(0)); for(let y=0;y<m.length;y++)for(let x=0;x<m[0].length;x++) r[x][m.length-1-y]=m[y][x]; return r; }
    collide(m,ox,oy){ for(let y=0;y<m.length;y++) for(let x=0;x<m[0].length;x++){ if(!m[y][x]) continue; const nx=ox+x, ny=oy+y; if(nx<0||nx>=this.w||ny>=this.h) return true; if(ny>=0 && this.board[ny][nx]) return true; } return false; }
    lock(){ const m=this.cur.m; for(let y=0;y<m.length;y++) for(let x=0;x<m[0].length;x++) if(m[y][x]){ const nx=this.cur.x+x, ny=this.cur.y+y; if(ny>=0) this.board[ny][nx]=this.cur.c; }
      let lines=0; for(let y=this.h-1;y>=0;y--){ if(this.board[y].every(v=>v)){ this.board.splice(y,1); this.board.unshift(Array(this.w).fill(0)); lines++; y++; } }
      if(lines) this.score+=lines*100; this.spawn();
    }
    move(dx){ if(!this.collide(this.cur.m,this.cur.x+dx,this.cur.y)) this.cur.x+=dx; }
    rotate(){ const r=this.rot(this.cur.m); if(!this.collide(r,this.cur.x,this.cur.y)) this.cur.m=r; }
    softDrop(){ if(!this.collide(this.cur.m,this.cur.x,this.cur.y+1)) this.cur.y++; else this.lock(); }
    update(dt){ this.t+=dt; if(this.t>this.step){ this.t=0; this.softDrop(); } }
    draw(){ ctx.fillStyle='#0c1328'; ctx.fillRect(0,0,canvas.width,canvas.height);
      const s=Math.floor(Math.min(canvas.height/20, canvas.width/10)); const offX=(canvas.width-10*s)/2, offY=(canvas.height-20*s)/2;
      for(let y=0;y<this.h;y++) for(let x=0;x<this.w;x++){ const v=this.board[y][x]; ctx.fillStyle=v?this.colors[v]:'rgba(255,255,255,.06)'; ctx.fillRect(offX+x*s+1, offY+y*s+1, s-2, s-2); }
      ctx.fillStyle=this.colors[this.cur.c];
      for(let y=0;y<this.cur.m.length;y++) for(let x=0;x<this.cur.m[0].length;x++) if(this.cur.m[y][x]) ctx.fillRect(offX+(this.cur.x+x)*s+1, offY+(this.cur.y+y)*s+1, s-2, s-2);
      drawHUD(this.score);
    }
    key(k,d){ if(!d) return; if(k==='ArrowLeft') this.move(-1); if(k==='ArrowRight') this.move(1); if(k==='ArrowUp') this.rotate(); if(k==='ArrowDown') this.softDrop(); }
  }

  function drawHUD(score){ ctx.font='20px ui-monospace, Menlo, monospace'; ctx.fillStyle='rgba(234,246,255,.85)'; ctx.fillText('Score: '+score,16,28); ctx.fillText('Best: '+best,16,52); }

  function gameOver(){ running=false; $('#state').textContent='game over';
    if(game.score>best){ best=game.score; localStorage.setItem(BEST_KEY,best); $('#best').textContent=best; }
    saveLB(); ctx.fillStyle='rgba(0,0,0,.55)'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle='#eaf6ff'; ctx.font='28px ui-monospace,Menlo,monospace'; ctx.fillText('Game Over ‚Äì Press Play to restart',220,canvas.height/2);
  }

  function startGame(){ const type=$('#game').value;
    game = type==='snake'? new Snake() : type==='2048'? new G2048() : type==='tetris'? new Tetris() : new Flappy();
    game.start(); running=true; paused=false; $('#state').textContent='playing'; $('#score').textContent='0'; last=0; requestAnimationFrame(loop);
  }
  function loop(ts){ if(!running) return; if(!last) last=ts; const dt=ts-last; last=ts; frames++; if(frames%12===0) $('#fps').textContent=Math.round(1000/dt); if(!paused){ game.update(dt); game.draw(); $('#score').textContent=game.score; } requestAnimationFrame(loop); }
  window.addEventListener('keydown',e=>{ if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','Space'].includes(e.code)) e.preventDefault(); if(e.code==='KeyP'){paused=!paused; $('#state').textContent=paused?'paused':'playing'; return;} if(game) game.key(e.code,true) }); window.addEventListener('keyup',e=>{ if(game) game.key(e.code,false) }); $('#playBtn').onclick=startGame;

  // leaderboard (safe render)
  function saveLB(){
    const g=$('#game').value, p=getProfile();
    const lb=getLB(); const e={ts:Date.now(), nick:cleanText(p.nickname||'guest',20), addr:cleanText(p.payout||'‚Äî',60), score:game.score};
    (lb[g]=lb[g]||[]).push(e); lb[g].sort((a,b)=>b.score-a.score); lb[g]=lb[g].slice(0,20); setLB(lb); renderLB();
  }
  function renderLB(){
    const g = $('#lbGame').value, lb = getLB()[g]||[]; const box=$('#leaderList'); box.innerHTML='';
    lb.forEach((e,i)=>{
      const row=document.createElement('div'); row.className='leader-item';
      const rank=document.createElement('span'); rank.textContent='#'+(i+1);
      const nick=document.createElement('strong'); nick.textContent=e.nick||'guest';
      const addr=document.createElement('span'); addr.className='kbd'; addr.textContent=(e.addr && e.addr!=='‚Äî') ? (e.addr.slice(0,4)+'‚Ä¶'+e.addr.slice(-4)) : '‚Äî';
      const score=document.createElement('strong'); score.textContent=String(e.score);
      const time=document.createElement('span'); time.className='kbd'; time.textContent=new Date(e.ts).toLocaleString();
      row.append(rank,nick,addr,score,time); box.appendChild(row);
    });
    refreshCardStats();
  }
  $('#lbGame').onchange=renderLB; $('#clearLB').onclick=()=>{ const g=$('#lbGame').value, lb=getLB(); delete lb[g]; setLB(lb); renderLB(); };

  // card stats
  function k(g){return 'plays_'+g} function incPlays(g){localStorage.setItem(k(g), Number(localStorage.getItem(k(g))||0)+1); refreshCardStats(); }
  function bestOf(g){ const lb=getLB()[g]; return lb && lb[0] ? lb[0].score : '‚Äî'; }
  function playsOf(g){ return localStorage.getItem(k(g)) || '‚Äî'; }
  function refreshCardStats(){
    const map=[['flappy','sflappy','pflappy'],['snake','ssnake','psnake'],['2048','s2048','p2048'],['tetris','stetris','ptetris']];
    map.forEach(([g,hs,ps])=>{ const hsEl=$('#'+hs), psEl=$('#'+ps); if(hsEl) hsEl.textContent=bestOf(g); if(psEl) psEl.textContent=playsOf(g); });
  }
  refreshCardStats();

  // initial splash
  (function(){ const ctx=canvas.getContext('2d'); ctx.fillStyle='#071120'; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.fillStyle='#eaf6ff'; ctx.font='28px ui-monospace,Menlo,monospace'; ctx.fillText('Choose a card to start playing', 260, canvas.height/2); })();

  // Pay with Phantom - direct SOL
  const { Connection, SystemProgram, Transaction, PublicKey } = solanaWeb3;
  const connection = new Connection('https://api.mainnet-beta.solana.com', 'confirmed');
  const payBtn = $('#phantomPayBtn'); const amt = $('#amountSol'); const tre = $('#treasuryAddress');
  payBtn?.addEventListener('click', async () => {
    try {
      if (!window.solana || !window.solana.isPhantom) return alert('Please install Phantom wallet.');
      const res = await window.solana.connect(); const fromPubkey = res.publicKey;
      const to = tre.value.trim(); if (!to) return alert('Enter your treasury address.'); if(!looksLikeSol(to)) return alert('That does not look like a valid Solana address.');
      const toPubkey = new PublicKey(to);
      const amount = Number(amt.value); if (!amount || amount <= 0) return alert('Enter a valid amount in SOL.');
      const lamports = Math.round(amount * 1e9);
      const tx = new Transaction().add(SystemProgram.transfer({ fromPubkey, toPubkey, lamports }));
      const { blockhash, lastValidBlockHeight } = await connection.getLatestBlockhash();
      tx.recentBlockhash = blockhash; tx.feePayer = fromPubkey;
      const signed = await window.solana.signTransaction(tx);
      const sig = await connection.sendRawTransaction(signed.serialize());
      await connection.confirmTransaction({ signature: sig, blockhash, lastValidBlockHeight }, 'confirmed');
      alert('Payment sent!\\nSignature: ' + sig);
    } catch (e) { console.error(e); alert('Payment failed: ' + (e?.message || e)); }
  });
})();
</script>
</body>
</html>
